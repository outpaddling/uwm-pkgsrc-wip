# $NetBSD$
#
###########################################################
#                  Generated by fbsd2pkg                  #
#              Thu Jul 20 18:34:44 CDT 2017               #
###########################################################

DISTNAME=	canu-${PORTVERSION}
CATEGORIES=	biology java
MASTER_SITES=	${MASTER_SITE_GITHUB:=marbl/}
GITHUB_PROJECT=	canu
GITHUB_TAG=	v${PORTVERSION}

MAINTAINER=	bacon4000@gmail.com
HOMEPAGE=	http://canu.readthedocs.io/
COMMENT=	Single molecule sequence assembler for genomes large and small

# Check this
LICENSE=	gnu-gpl-v2

# Too heavy.  Disable check in canu command instead.
# DEPENDS+=	gnuplot>0:../../graphics/gnuplot

# Screwy Makefile compiles directly into ${DESTDIR}${PREFIX}
SUBST_CLASSES+=		optimize
SUBST_STAGE.optimize=	post-patch
SUBST_SED.optimize+=	-e 's|-O4|-O2|g'
SUBST_SED.optimize+=	-e 's|-funroll-loops||g'
SUBST_SED.optimize+=	-e 's|-fexpensive-optimizations||g'
SUBST_FILES.optimize+=	${WRKSRC}/Makefile

SUBST_CLASSES+=		jar
SUBST_STAGE.jar=	post-patch
SUBST_SED.jar=		-e 's|\\$$bin/mhap-|${PREFIX}/${JAVAJARDIR}/mhap-|g'
SUBST_FILES.jar=	${WRKSRC}/pipelines/canu/OverlapMhap.pm

SUBST_CLASSES+=		perl
SUBST_STAGE.perl=	post-patch
SUBST_SED.perl=		-e 's|RealBin/lib|RealBin/../${SITE_PERL_REL}|g'
SUBST_FILES.perl=	${WRKSRC}/pipelines/canu.pl

REPLACE_PERL+=	bogart/*.pl \
		pipelines/*.pl \
		bogus/*.pl \
		bogart-analysis/*.pl \
		overlapBasedTrimming/*.pl \
		overlapInCore-analysis/*.pl \
		merTrim/*.pl \
		erateEstimate/*.pl \
		meryl/.pl \
		fastq-utilities/*.pl \
		*.pl

# May work on other 64-bit processors, but untested
ONLY_FOR_PLATFORM=	 *-*-x86_64

USE_LANGUAGES=	c c++
USE_JAVA=	run
USE_JAVA2=	8
USE_TOOLS+=	gmake pax perl

GCC_REQD+=	4.8

WRKSRC=		${WRKDIR}/canu-${PORTVERSION}/src

MAKE_ENV+=	DESTDIR=${WRKSRC}

PORTVERSION=	1.5

TMP_INST=	${WRKSRC}${PREFIX}/${OPSYS}-${MACHINE_ARCH:S/x86_64/amd64/}
SITE_PERL_REL=	lib/perl5/site_perl
JAVAJARDIR=	share/java/classes
INSTALLATION_DIRS=	bin \
			${SITE_PERL_REL} \
			${JAVAJARDIR}

post-build:
	${MKDIR} ${TMP_INST}/${SITE_PERL_REL}
	${MV} ${TMP_INST}/bin/lib/canu ${TMP_INST}/${SITE_PERL_REL}
	${RMDIR} ${TMP_INST}/bin/lib
	${MV} ${TMP_INST}/bin/*.a ${TMP_INST}/lib
	${MKDIR} ${TMP_INST}/${JAVAJARDIR}
	${MV} ${TMP_INST}/bin/*.jar ${TMP_INST}/${JAVAJARDIR}

do-install:
	cd ${TMP_INST}/bin && ${PAX} -wr * ${DESTDIR}${PREFIX}/bin
	cd ${TMP_INST}/lib && ${PAX} -wr * ${DESTDIR}${PREFIX}/lib
	cd ${TMP_INST}/share && ${PAX} -wr * ${DESTDIR}${PREFIX}/share

.include "../../devel/boost-libs/buildlink3.mk"
.include "../../lang/perl5/module.mk"
.include "../../mk/bsd.pkg.mk"
