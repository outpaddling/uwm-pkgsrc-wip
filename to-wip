#!/bin/sh -e

##########################################################################
#   Function description:
#       Pause until user presses return
##########################################################################

pause()
{
    local junk
    
    printf "Press return to continue..."
    read junk
}

if [ $# != 1 ]; then
    printf "Usage: $0 pkg-name\n"
    exit 1
fi

# Strip trailing /
pkg=`basename "$1"`

if `echo $pkg | fgrep -q '/'`; then
    printf "Package name must not contain a '/'.\n"
    exit 1
fi

if [ ! -e $pkg ]; then
    printf "${pkg}: No such package.\n"
    exit 1
fi

if [ ! -e ../wip ]; then
    printf "Missing ../wip.\n"
    exit 1
fi

if [ -e ../wip/$pkg ]; then
    printf "../wip/$pkg already exists.\n"
    exit
fi

if fgrep uwm-pkgsrc-wip $pkg/Makefile; then
    printf "$pkg has dependencies in uwm-pkgsrc-wip.\n"
    printf "Move them to wip first.\n"
    exit 1
fi

if [ -z EDITOR ]; then
    EDITOR=vi
fi

if [ `uname` = 'NetBSD' ]; then
    make='make'
else
    make='bmake'
fi

cd ../wip
git pull --rebase || true

cd ../uwm-pkgsrc-wip/$pkg
svn ci -m 'Clean up'

# Copy pkg to wip
$make clean || true
cd ..
rsync -av --delete $pkg ../wip

# Remove files from other version control systems
cd ../wip/$pkg
find . -depth -name CVS -exec rm -rf '{}' \;
find . -depth -name .svn -exec rm -rf '{}' \;
$make makesum || true

suffix=uwm-pkgsrc-wip-to-wip
sed -e 's|uwm-pkgsrc-wip|wip|g' Makefile > Makefile.$suffix
mv -f Makefile.$suffix Makefile
if [ -e buildlink3.mk ]; then
    sed -e 's|uwm-pkgsrc-wip|wip|g' buildlink3.mk > buildlink3.mk.$suffix
    mv -f buildlink3.mk.$suffix buildlink3.mk
fi

$EDITOR Makefile
if [ -e buildlink3.mk ]; then
    $EDITOR buildlink3.mk
fi

printf "Continue? y/[n] "
read continue
if [ 0$continue != 0y ]; then
    exit
fi

# Add TODO file
if [ ! -e TODO ]; then
    printf "Clean up and test\n" > TODO
fi

# Add new package to git repo
../../uwm-pkgsrc-wip/import-package.sh

# Cleanly remove from uwm-pkgsrc-wip
cd ../../uwm-pkgsrc-wip

printf "Editing dependent packages.  Convert uwm-pkgsrc-wip/$pkg depends to wip/$pkg.\n"
pause
./edit-deps $pkg

./wip-diff $pkg || true
printf "Remove $pkg? y/[n] "
read remove
if [ 0$remove = 0y ]; then
    svn rm $pkg
    svn ci -m "$pkg: Move to wip"
fi
