# $NetBSD$
#
###########################################################
#                  Generated by fbsd2pkg                  #
#              Wed Apr 26 12:04:04 CDT 2017               #
###########################################################

# Do not confuse net/xrdp with x11-servers/x11rdp.  This port is not
# former version or name of net/xrdp. x11rdp is fundamentally an X server.
# xrdp is a RDP server.  They work together.  Neither xrdp nor x11rdp
# can be used fully functionally without the other.
# Simply saying, net/xrdp is front-end, x11-servers/x11rdp is back-end.

# What's the pkgsrc equivalent?
# RUN_DEPENDS=	xorg-fonts>=0:x11-fonts/xorg-fonts
#USE_OPENSSL=	yes

DISTNAME=	x11rdp_xorg71
PKGNAME=	x11rdp-${PORTVERSION}

PKGNAME=	x11rdp-${PORTVERSION}
DIST_SUBDIR=	xrdp
CATEGORIES=	x11-servers
MASTER_SITES=	https://xrdp.vmeta.jp/pub/xrdp/:x11rdp \
		http://www.club.kyutech.ac.jp/~meta/distfiles/:x11rdp
DISTFILES=	x11rdp_xorg71_r${X11RDPREVISION}.tar.gz

MAINTAINER=	dsiercks
HOMEPAGE=	http://www.xrdp.org/
COMMENT=	X11 server for xrdp
LICENSE=	mit

# Careful here: substis on top of patches
SUBST_CLASSES+=		prefix
SUBST_STAGE.prefix=	post-patch
SUBST_SED.prefix+=	-e "s|%%PREFIX%%|${PREFIX}|g"
SUBST_FILES.prefix+=	${WRKSRC}/buildx.sh

SUBST_CLASSES+=		cc
SUBST_STAGE.cc=		post-patch
SUBST_SED.cc+=		-e "s|%%CC%%|${CC}|g"
SUBST_FILES.cc+=	${WRKSRC}/buildx.sh

SUBST_CLASSES+=		cxx
SUBST_STAGE.cxx=	post-patch
SUBST_SED.cxx+=		-e "s|%%CXX%%|${CXX}|g"
SUBST_FILES.cxx+=	${WRKSRC}/buildx.sh

SUBST_CLASSES+=		cpp
SUBST_STAGE.cpp=	post-patch
SUBST_SED.cpp+=		-e "s|%%CPP%%|${CPP}|g"
SUBST_FILES.cpp+=	${WRKSRC}/buildx.sh

SUBST_CLASSES+=		make
SUBST_STAGE.make=	post-patch
SUBST_SED.make+=	-e "s|%%MAKE_CMD%%|${MAKE_PROGRAM}|g"
SUBST_FILES.make+=	${WRKSRC}/buildx.sh

# FIXME: Come up with a better patch that can be sent upstream
SUBST_CLASSES+=		libz
SUBST_STAGE.libz=	post-patch
SUBST_SED.libz+=	-e "s|\"-lz|\"-L${PREFIX}/lib -lz|g"
SUBST_SED.libz+=	-e "s|Z_LIBS=-lz|Z_LIBS=\"-L${PREFIX}/lib -lz\"|g"
SUBST_FILES.libz+=	${WRKSRC}/libXfont-X11R7.1-1.1.0/configure

SUBST_CLASSES+=		libz2
SUBST_STAGE.libz2=	post-patch
SUBST_SED.libz2+=	-e "s|-lz|-L${PREFIX}/lib -lz|g"
SUBST_FILES.libz2+=	${WRKSRC}/xorg-server-X11R7.1-1.1.0/configure
SUBST_FILES.libz2+=	${WRKSRC}/xorg-server-X11R7.1-1.1.0/hw/rdp/Makefile

# FIXME: Reverts a static patch.  Better to eliminate the patch and
# subst GNU_SOURCE to BSD_SOURCE.
.include "../../mk/bsd.prefs.mk"
.if ${OPSYS} == Linux
SUBST_CLASSES+=		source
SUBST_STAGE.source=	post-patch
SUBST_SED.source+=	-e "s|BSD_SOURCE|GNU_SOURCE|g"
SUBST_FILES.source+=	${WRKSRC}/buildx.sh
.endif

USE_LIBTOOL=	yes
USE_LANGUAGES=	fortran c c++
USE_TOOLS+=	gmake perl pkg-config

LDFLAGS+=	-L${PREFIX}/lib -Wl,-rpath,${PREFIX}/lib

PORTVERSION=	0.5.0.${X11RDPREVISION}
X11RDPREVISION=	299

INSTALLATION_DIRS=	bin

post-extract:
	@${MKDIR} ${WRKSRC}/build_dir

do-build:
	cd ${WRKSRC} && \
		GNUMAKE=${MAKE_PROGRAM} ${SH} ${WRKSRC}/buildx.sh \
		${WRKSRC}/build_dir

do-install:
	${INSTALL_PROGRAM} \
		${WRKSRC}/build_dir/bin/X11rdp ${DESTDIR}${PREFIX}/bin/

.include "../../devel/zlib/buildlink3.mk"
.include "../../x11/xproto/buildlink3.mk"
.include "../../x11/libICE/buildlink3.mk"
.include "../../x11/xtrans/buildlink3.mk"
.include "../../x11/xextproto/buildlink3.mk"
.include "../../x11/libXau/buildlink3.mk"
.include "../../x11/bigreqsproto/buildlink3.mk"
.include "../../x11/xcmiscproto/buildlink3.mk"
.include "../../x11/libXdmcp/buildlink3.mk"
.include "../../x11/kbproto/buildlink3.mk"
.include "../../x11/libSM/buildlink3.mk"
.include "../../x11/libX11/buildlink3.mk"
.include "../../x11/fontcacheproto/buildlink3.mk"
.include "../../mk/bsd.pkg.mk"
