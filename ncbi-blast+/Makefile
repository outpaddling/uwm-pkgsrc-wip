# $NetBSD$
#
###########################################################
#                  Generated by fbsd2pkg                  #
#              Mon Mar 26 08:34:17 CDT 2018               #
###########################################################

# LIB_DEPENDS=
#		libtspi.so:security/trousers \

DISTNAME=	ncbi-blast-${PORTVERSION}+-src
PKGNAME=	ncbi-blast+-${PORTVERSION}
CATEGORIES=	biology
MASTER_SITES=	https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/LATEST/ \
		https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/${PORTVERSION}/

MAINTAINER=	jwb@FreeBSD.org
HOMEPAGE=	http://blast.ncbi.nlm.nih.gov/
COMMENT=	NCBI implementation of Basic Local Alignment Search Tool
LICENSE=	public-domain

# Fix "undefined _ThreadRuneLocale" error on FreeBSD 10.0
# Fix unknown options in configure
SUBST_CLASSES+=		thread
SUBST_STAGE.thread=	post-patch
SUBST_SED.thread+=	-e 's|-D_THREAD_SAFE|-D_THREAD_SAFE -D__RUNETYPE_INTERNAL|'
SUBST_SED.thread+=	-e '/--infodir=DIR/d'
SUBST_SED.thread+=	-e '/--mandir=DIR/d'
SUBST_FILES.thread+=	${WRKSRC}/src/build-system/configure

# Add staging support to configure-generated Makefile
SUBST_CLASSES+=		stage
SUBST_STAGE.stage=	post-patch
SUBST_SED.stage+=	-e 's|@prefix@|${DESTDIR}@prefix@|g'
SUBST_FILES.stage+=	${WRKSRC}/src/build-system/Makefile.in.top

USE_TOOLS+=	gmake
USE_LANGUAGES=	c c++
GNU_CONFIGURE=	yes
REPLACE_BASH=	compilers/xcode30_prj/configure
REPLACE_PERL=	src/app/blast/legacy_blast.pl src/app/blast/update_blastdb.pl
REPLACE_PYTHON=	src/app/winmasker/windowmasker_2.2.22_adapter.py

WRKSRC=			${WRKDIR}/${DISTNAME}/c++

# The test for amq can hang, but amq is not needed so just avoid the test
# configure chooses /usr/local/bin/ar with no flags
# FreeBSD boost port flagged by configure as untested version
CONFIGURE_ENV=		ncbi_cv_prog_amq_w=no
CONFIGURE_ARGS+=	AR="ar cr" --without-boost

CFLAGS+=	-fopenmp
CXXFLAGS+=	-fopenmp
MAKE_JOBS_SAFE=	no	# Intermittent issues

PORTVERSION=	2.7.1

INSTALLATION_DIRS=	lib/ncbi-tools++

.include "../../mk/bsd.prefs.mk"

.if ${OPSYS} == NetBSD
# statfs is deprecated on NetBSD, but still exists in the library
# configure checks only for undefined reference, not for usability
CONFIGURE_ENV+=         ac_cv_func_statfs=no
.endif

# --libdir=${PREFIX}/lib/ncbi-tools++ doesn't respect DESTDIR, so do
# a postinstall mv.
post-install:
	${RM} ${DESTDIR}${PREFIX}/include/ncbi-tools++/*/*/.cvsignore.extra
	${MV} ${DESTDIR}${PREFIX}/lib/lib* \
		${DESTDIR}${PREFIX}/lib/ncbi-tools++
	${STRIP} ${DESTDIR}${PREFIX}/lib/ncbi-tools++/*.so

.include "../../devel/zlib/buildlink3.mk"
.include "../../archivers/lzo/buildlink3.mk"
.include "../../archivers/bzip2/buildlink3.mk"
.include "../../devel/pcre/buildlink3.mk"
.include "../../databases/lmdb/buildlink3.mk"
.include "../../security/gnutls/buildlink3.mk"
.include "../../devel/gmp/buildlink3.mk"
.include "../../devel/libidn2/buildlink3.mk"
.include "../../security/nettle/buildlink3.mk"
.include "../../security/libtasn1/buildlink3.mk"
.include "../../security/p11-kit/buildlink3.mk"
.include "../../security/libgcrypt/buildlink3.mk"
.include "../../databases/sqlite3/buildlink3.mk"
.include "../../security/libgpg-error/buildlink3.mk"
.include "../../lang/python/application.mk"
.include "../../mk/bsd.pkg.mk"
