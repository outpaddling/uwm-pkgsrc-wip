# $NetBSD$
#
###########################################################
#                  Generated by fbsd2pkg                  #
#              Tue Sep 13 16:16:55 CDT 2016               #
###########################################################

## FIXME: PBBAM is available as a port now

SUBST_CLASSES+=		libs
SUBST_STAGE.libs=	post-configure
SUBST_SED.libs+=	-e 's|-lhdf5$$|-lhdf5 -lsz|g'
SUBST_SED.libs+=	-e 's|-ldl||g'
SUBST_SED.libs+=	-e 's|-lrt||g'
SUBST_SED.libs+=	-e 's|-static||g'
SUBST_FILES.libs+=	${WRKSRC}/defines.mk

DISTNAME=	blasr-${PORTVERSION}
CATEGORIES=	biology
MASTER_SITES=	${MASTER_SITE_GITHUB:=PacificBiosciences/}
GITHUB_PROJECT=	blasr
GITHUB_TAG=	0061445b1387c545780679776d3d483a30d4332b

MAINTAINER=	bacon4000@gmail.com
HOMEPAGE=	https://github.com/PacificBiosciences/blasr
COMMENT=	PacBio(R) long read aligner
LICENSE=	modified-bsd

# Test and change if necessary.
# MAKE_JOBS_SAFE=	no

# Just assuming C and C++: Adjust this!
USE_LANGUAGES=	c c++
USE_TOOLS+=	gmake
USE_CMAKE=	yes
RPATH=		${COMPILER_RPATH_FLAG}${PREFIX}/lib
CMAKE_ARGS= \
	-DPBDATA_ROOT_DIR:STRING=${PREFIX}/include/blasr_libcpp \
	-DPacBioBAM_INCLUDE_DIRS:STRING=${PREFIX}/include/pbbam \
	-DPacBioBAM_LIBRARIES:STRING="${RPATH} -lpbbam" \
	-DHTSLIB_INCLUDE_DIRS:STRING=${PREFIX}/include/htslib \
	-DHTSLIB_LIBRARIES:STRING="${RPATH} -lhts" \
	-DPBDATA_INCLUDE_DIRS:STRING=${PREFIX}/include/blasr_libcpp/pbdata \
	-DPBDATA_LIBRARIES:STRING="${RPATH} -lpbdata" \
	-DPBIHDF_INCLUDE_DIRS:STRING=${PREFIX}/include/blasr_libcpp/hdf \
	-DPBIHDF_LIBRARIES:STRING="${RPATH} -lpbihdf" \
	-DBLASR_INCLUDE_DIRS:STRING=${PREFIX}/include/blasr_libcpp/alignment \
	-DBLASR_LIBRARIES:STRING="${RPATH} -lblasr" \
	-DHDF5_INCLUDE_DIRS:STRING=${PREFIX}/include \
	-DHDF5_CPP_LIBRARIES:STRING="${RPATH} -lhdf5_cpp" \
	-DHDF5_LIBRARIES:STRING="${RPATH} -lhdf5" \
	..

WRKSRC=		${WRKDIR}/blasr-${GITHUB_TAG}

CXXFLAGS+=	-I${PREFIX}/include/blasr_libcpp \
		-I${PREFIX}/include/blasr_libcpp/hdf \
		-I${PREFIX}/include/blasr_libcpp/pbdata \
		-I${PREFIX}/include/blasr_libcpp/alignment \
		-I${PREFIX}/include
GCC_REQD=	4.9
MAKE_FILE=	makefile

PORTVERSION=	2016.09.07

INSTALLATION_DIRS=	bin include lib ${PKGMANDIR}/man1 share/doc share/examples

do-configure:
	cd ${WRKSRC} && ./configure.py --no-pbbam \
		NOPBBAM=1 HDF5_INCLUDE=${PREFIX}/include \
		HDF5_LIB=${PREFIX}/lib

post-build:
	${MKDIR} ${WRKSRC}/utils/bax2bam/build
	cd ${WRKSRC}/utils/bax2bam/build && \
		cmake ${CMAKE_ARGS} -DBax2BAM_build_tests:BOOL=OFF && \
		${MAKE} VERBOSE=1
#	Seems to be broken
#	${MKDIR} ${WRKSRC}/utils/bam2bax/build
#	cd ${WRKSRC}/utils/bam2bax/build && \
#		cmake ${CMAKE_ARGS} -DBam2Bax_build_tests:BOOL=OFF && \
#		${MAKE} VERBOSE=1

do-install:
	${INSTALL_PROGRAM} \
		${WRKSRC}/blasr \
		${WRKSRC}/utils/loadPulses \
		${WRKSRC}/utils/pls2fasta \
		${WRKSRC}/utils/samFilter \
		${WRKSRC}/utils/samtoh5 \
		${WRKSRC}/utils/samtom4 \
		${WRKSRC}/utils/sawriter \
		${WRKSRC}/utils/sdpMatcher \
		${WRKSRC}/utils/toAfg \
		${WRKSRC}/utils/bax2bam/bin/* \
		${DESTDIR}${PREFIX}/bin
#		${WRKSRC}/utils/bam2bax/bin/* \

.include "../../jb-wip/blasr_libcpp-devel/buildlink3.mk"
.include "../../wip/pbbam/buildlink3.mk"
.include "../../devel/hdf5-c++/buildlink3.mk"
.include "../../wip/htslib/buildlink3.mk"
.include "../../archivers/szip/buildlink3.mk"
.include "../../security/openssl/buildlink3.mk"
.include "../../devel/libconfig/buildlink3.mk"
.include "../../devel/boost-libs/buildlink3.mk"
.include "../../mk/bsd.pkg.mk"
