# $NetBSD$
#
###########################################################
#                  Generated by fbsd2pkg                  #
#              Fri Mar 25 16:05:36 CDT 2016               #
###########################################################

###########################################################
# Unconverted and partially converted FreeBSD port syntax:

DISTNAME=	MUMPS_${PORTVERSION}
PKGNAME=	mumps-${PORTVERSION}
CATEGORIES=	math
MASTER_SITES=	http://mumps.enseeiht.fr/ \
		http://graal.ens-lyon.fr/MUMPS/ \
		http://www.enseeiht.fr/apo/MUMPS/ \
		http://www.enseeiht.fr/irit/apo/MUMPS/

MAINTAINER=	bacon4000@gmail.com
HOMEPAGE=	http://graal.ens-lyon.fr/MUMPS/
COMMENT=	MUltifrontal Massively Parallel sparse direct Solver
# LICENSE=	${WRKSRC}/LICENSE

SUBST_CLASSES+=		compiler
SUBST_STAGE.compiler=	pre-build
SUBST_SED.compiler+=	-e 's|@CC@|${CC}|g' \
			-e 's|@FC@|${FC}|g' \
			-e 's|@CFLAGS@|${CFLAGS}|g' \
			-e 's|@FCFLAGS@|${FCFLAGS}|g' \
			-e 's|@GCCLIBDIR@|${GCCLIBDIR}|g' \
			-e 's|@FORTRANLIBS@|${FORTRANLIBS}|g' \
			-e 's|@BLAS_LIBS@|${BLAS_LIBS}|' \
			-e 's|@LOCALBASE@|${PREFIX}|g' \
			-e 's|\#LMETIS|LMETIS|'
SUBST_FILES.compiler+=	${WRKSRC}/Makefile.inc

DEPENDS+=	metis>=4:../../math/metis

# Causes undefined reference to main on CentOS 6
#FORTRANLIBS=	-lgfortran
GCCLIBDIR=	${LDFLAGS}
BLAS_LIBS=	-lblas
LAPACK_LIBS=	-llapack

# Test and change if necessary.
MAKE_JOBS_SAFE=	no

USE_LANGUAGES=	c c++ fortran

FFLAGS+=	-O3 -ffast-math
# Check this
MAKE_ENV=	ORDERINGSF=-Dmetis

PORTVERSION=	4.10.0
DATADIR=	${PREFIX}/share/mumps
DOCSDIR=	${PREFIX}/share/doc/mumps
EXAMPLESDIR=	${PREFIX}/share/examples/mumps
GZIP_CMD=	gzip

# Sets OPSYS, OS_VERSION, MACHINE_ARCH, etc..
# .include "../../mk/bsd.prefs.mk"

# Keep this if there are user-selectable options.
# .include "options.mk"

# Specify which directories to create before install.
# You should only need this if using your own install target.
INSTALLATION_DIRS=	bin include lib ${DOCSDIR} ${EXAMPLESDIR}

pre-configure:
	${INSTALL_DATA} ${WRKSRC}/Make.inc/Makefile.inc.generic.SEQ \
		${WRKSRC}/Makefile.inc

do-install:
	${INSTALL_DATA} ${WRKSRC}/include/*.h ${DESTDIR}${PREFIX}/include
	${INSTALL_DATA} ${WRKSRC}/lib/lib*.a ${DESTDIR}${PREFIX}/lib
.ifndef WITH_MPI
	${INSTALL_DATA} ${WRKSRC}/libseq/libmpiseq.a ${DESTDIR}${PREFIX}/lib
.endif
	${INSTALL_DATA} ${WRKSRC}/doc/userguide_${PORTVERSION}.pdf ${DESTDIR}${DOCSDIR}
	${INSTALL_DATA} ${WRKSRC}/doc/userguide_${PORTVERSION}.ps ${DESTDIR}${DOCSDIR}
	${GZIP_CMD} ${DESTDIR}${DOCSDIR}/userguide_${PORTVERSION}.ps
. for ex in Makefile README *.c *.F input_simpletest_*
	${INSTALL_DATA} ${WRKSRC}/examples/${ex} ${DESTDIR}${EXAMPLESDIR}
. endfor
. for ex in c_example *simpletest
	${INSTALL_PROGRAM} ${WRKSRC}/examples/${ex} ${DESTDIR}${EXAMPLESDIR}
. endfor

regression-test:
	(cd ${WRKSRC}/examples &&	\
	./ssimpletest < input_simpletest_real ;			\
	./dsimpletest < input_simpletest_real ;			\
	./csimpletest < input_simpletest_cmplx ;		\
	./zsimpletest < input_simpletest_cmplx ;		\
	${ECHO_MSG} "The solution should be (1,2,3,4,5)" ;	\
	./c_example ;						\
	${ECHO_MSG} "The solution should be (1,2)")

# Convert any _DEPENDS above that have a buildlink3.mk
.include "../../math/lapack/buildlink3.mk"
.include "../../math/blas/buildlink3.mk"
# Linux doesn't have zlib in the base, so just in case...
# .include "../../devel/zlib/buildlink3.mk"
.include "../../mk/bsd.pkg.mk"
